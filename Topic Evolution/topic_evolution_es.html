<!DOCTYPE html>
<html class="ocks-org do-not-copy">
<meta charset="utf-8">
<title>Evolución de los intereses</title>
<style>

@import url(style.css?aea6f0a);

#chart {
  margin-left: -40px;
  height: 506px;
}

text {
  font: 10px sans-serif;
}

.dot {
  stroke: #000;
}

.axis path, .axis line {
  fill: none;
  stroke: #000;
  shape-rendering: crispEdges;
}

.label {
  fill: #777;
}

.year.label {
  font: 500 100px "Helvetica Neue";
  fill: #ddd;
}

.year.label.active {
  fill: #aaa;
}

.overlay {
  fill: none;
  pointer-events: all;
  cursor: ew-resize;
}

.ocks-org table, 
.ocks-org select,
.ocks-org input {
  font: normal 13px Arial;
}
.ocks-org button {
  font: normal 42px Arial;
  -moz-border-radius: 5px;
  -webkit-border-radius: 5px;
  padding: 10px;
}

</style>

<p id="chart"></p>

<div id="control_panel">
	<table id="control_panel_table">
		<col width="30%">
		<col width="50%">
		<col width="20%"> 
		<tr>
			<td>
				<big><b>Seleccionar todos o algunos tópicos</b></big>
			</td>
			<td></td>
			<td></td>
		</tr>
		<tr>
			<td>
				<select multiple id="topic_filter" name="topic_filter" size="4" style="width: 280px;">
				</select>
			</td>
			<td>
				<button onclick="cleanAndStart()">Empezar</button>
			</td>
			<td>
				<aside id="overlay_help"></aside>
			</td>
		</tr>
		<tr>
			<td style="text-align:left">
				<input type="checkbox" id="trace_checkbox"/><label>Dibujar el rastro de la evolución del tópico</label></input>
			</td>
			<td></td>
			<td></td>
		</tr>
	</table>
</div>

<div id="topics_comments">
</div>

<script src="d3.v3.min.js"></script>
<script>

// Various accessors that specify the four dimensions of data to visualize.
function x(d) { return d.income; }
function y(d) { return d.lifeExpectancy; }
function radius(d) { return d.population; }
function color(d) { return d.region; }
function key(d) { return d.name; }

var menu_topics = {
	"all":"All",
    "empleo":"Empleo",
    "economia":"Economía",
    "corrupcion":"Corrupción",
    "internacional":"Internacional",
    "terrorismo":"Terrorismo",
    "social":"Social",
    "salud":"Salud",
    "inseguridad ciudadana":"Inseguridad ciudadana",
    "medio ambiente":"Medio ambiente",
    "jovenes":"Jóvenes",
    "justicia":"Justicia",
    "servicios publicos e infraestructuras":"Servicios públicos e infraestructuras",
    "educacion":"Educación",
    "guerras":"Guerras",
    "vivienda":"Vivienda",
    "politica":"Política",
    "tecnologia e investigacion":"Tecnología e investigación",
    "cultura":"Cultura",
    "fuerzas armadas":"Fuerzas armadas",
    "ideologia":"Ideología",
    "preocupaciones situaciones personales":"Preocupaciones situaciones personales"
}

var par = {"corrupcion":{nombre:"Corrupción",name:"Corruption",description:["Algunas palabras clave principales: Agencia Tributaria, Fraude Fiscal, Amnistía Fiscal ",
"Un tema muy importante en España estos días, hemos descubierto que nuestros políticos no hablan sobre corrupción muy a menudo, al menos en las sesiones de control. A pesar de la fuerte subida del número de casos conocidos estos últimos años, a principios de 2003 sigue siendo el único periodo donde se habla, cuando el gobierno de Aznar redujo los impuestos para hacer frente a los problemas de blanqueo de capitales y la evasión fiscal. Algunos partidos cuestionaron duramente  el momento ya que las elecciones generales de 2004 estaban previstas sólo unos meses después. ",
"El pueblo, sin embargo, ha reaccionado fuertemente a los múltiples escándalos desde 2010. Podemos ver un fuerte aumento desde ese año en adelante, coincidiendo con el final de la peor parte de la crisis financiera. 2013 vio una nueva oleada de casos de financiación ilegal y evasión fiscal con relación a los principales partidos políticos. Después de esto, la corrupción se ha convertido en el segundo tema más importante para los españoles (después del empleo). ",
"Sin embargo, la protesta pública no ha hecho eco en el Congreso. La última ola de escándalos, que involucra a casi todos los partidos en el país, no ha logrado a una mayor aparición de la cuestión en las sesiones de control."]},
		   "economia":{nombre:"Economía",name:"Economy",description:["Algunas palabras clave principales: Empresas, Política Industrial, Economía Española",
"Como era de esperar, 2008 se ve un aumento notable del interés de los políticos y la gente en Economía. La crisis financiera golpeó a España duramente, y provocó una burbuja inmobiliaria cuyos efectos duran hasta hoy (más sobre esto en la vivienda y el empleo)." ,
"Antes de eso, podemos observar que la introducción del euro en 2002 si molestó a los políticos, mientras que casi no parece haber ningún interés por parte de los españoles. Después de 2012 hay una marcada disminución en el interés de ambos grupos. Una posible razón podría ser que el foco de la crisis ya no está en los bancos o instituciones financieras, sino en problemas de la gente como el desempleo. ",
"La economía es en realidad el tema sobre el que mejor se refleja el interés del pueblo en los debates políticos."]},
		   "educacion":{nombre:"Educación",name:"Education",description:["Algunas palabras clave: Sistema Educativo, Formación Profesional, Fracaso Escolar",
"A pesar de los aumentos repentinos ocasionales de actividad en el Congreso, Educación ha seguido siendo un tema tranquilo durante los últimos 15 años. Por un lado, una gran parte de la población no tiene ningún interés natural en la educación, ya que ha terminado la suya. Por lo tanto, a pesar de ocasionales demostraciones de gran visibilidad, el CIS da a Educación una pequeña importancia relativa. ",
"Por otro lado, algunas situaciones de la política hicieron convirtió altamente politizados en los últimos años, lo que explica las breves oleadas de interés por parte del Congreso. La introducción del Plan Bolonia en 2008 se encontró con una fuerte oposición de muchos partidos, que argumentaban que era el primer paso hacia la privatización de las universidades. La resistencia del gobierno catalán a la denominada 'Ley Wert', que pretende reducir el número de horas lectivas en catalán, llevó a algunos acalorados intercambios en 2014, ya que fue visto como una forma de represión contra Cataluña. A pesar de todo esto, la educación nunca se supera un 4% en el barómetro del CIS."]},
		   "empleo":{nombre:"Empleo",name:"Jobs",description:["Algunas de las palabras clave principales: Reforma Laboral, Negociación Colectiva, Paro",
"El desempleo ha sido un problema en España durante muchos años. En los últimos 15 años, el valor del CIS sobre Empleo nunca ha bajado del 20%.",
"A pesar de ser uno de los problemas más acuciantes en España, la importancia del empleo ha sido en la mayoría moderada en las sesiones de control del Congreso. Puntos altos aislados en 2008 y 2012 podría indicar que el empleo sigue siendo un tema candente antes de las elecciones generales, pero aún en esas ocasiones la brecha sigue siendo marcadamente amplia."]},
		   "ideologia":{nombre:"Ideología",name:"Ideology",description:["Algunas de las palabras clave principales: Guerra Civil, Memoria Histórica, Vasco",
"La ideología pertenece a un grupo de problemas que, a pesar de que aparecen en el Congreso de vez en cuando, son de muy poca importancia para la población de acuerdo con la CIS. Pero en medio de una crisis financiera donde  la gente está perdiendo sus empleos y hogares, no debe sorprender a nadie que los españoles no se preocupen sobre temas como la memoria histórica o de las víctimas de la Guerra Civil. A pesar de eso, todavía hay períodos en los que esto importa y mantiene a nuestros representantes ocupados. Nos dimos cuenta que el último tema mencionado, las víctimas de la  Guerra Civil, a menudo salió a la luz en las sesiones de control de a finales de 2003. "]},
		   "inseguridad ciudadana":{nombre:"Inseguridad ciudadana",name:"Crime",description:["Algunas de las palabras clave principales: Seguridad Ciudadana, Policía, Guardia Civil",
"Casi siempre por debajo del 10% de interés, la Seguridad Ciudadana ha visto dos tendencias opuestas en los últimos años. Por un lado, hay un aumento de la presencia del tema en los debates del Congreso. Por otro lado, los españoles no la mencionan de modo alguno como una de sus principales preocupaciones desde 2007. La crisis y los problemas más urgentes que trajo podría ser una explicación para la última tendencia. ",
"La explicación detrás de la primera tendencia es bastante diferente de lo que uno puede esperar. A partir de 2010, la política de austeridad provocó que se redujera considerablemente el gasto en algunas áreas, una de ellas la fuerza de policial (Guardia Civil). Muy a menudo, los partidos antirecortes usan esta pregunta contra el partido gobernante. Por lo que, la Guardia Civil se convirtió en un tema de discusión en el Congreso ."]},
		   "jovenes":{nombre:"Jóvenes",name:"Youth",description:["Algunas de las palabras clave principales: Jóvenes, Paro Juvenil, Garantía Juvenil",
"Una cuestión irregular, pero siempre presente en el Congreso, Juventud cubre temas relacionados, tales como la falta de oportunidades y la emigración masiva de jóvenes altamente cualificados. Después de algunos años de atención reducida, el surgimiento de nuevos partidos políticos desde 2012 ha llevado a un aumentar los temas relacionados con la juventud. Los jóvenes se consideran  la llave en las próxima elecciones generales. ",
"La juventud está clasificado como un problema muy periférico por los españoles, sin duda, debido a la situación general del país."]},
		   "justicia":{nombre:"Justicia",name:"Justice",description:["Algunas de las palabras clave principales: General Fiscal, Estatuto Orgánico, Tribunal Supremo",
"El lento sistema judicial ha sido durante mucho tiempo un tema recurrente en España. El inicio de la crisis en 2008 desplazó la atención hacia otros temas, hasta que los casos de corrupción llevaron de nuevo al asunto. Decidimos tratar la Corrupción y Justicia por separado, ya que podríamos identificar dos grupos claramente. En contra de la corrupción, la Justicia aparece con más frecuencia en el Congreso desde 2012. Al parecer los políticos prefieren hablar de los jueces que sobre los juzgados",
"De todos modos, los españoles parecen ser capaces de identificar a uno de ellos como un problema real, y es la corrupción, no la justicia."]},
		   "medio ambiente":{nombre:"Medio ambiente",name:"Environment",description:["Algunas palabras clave son: Energías Renovables, Seguridad Nuclear, Cambio Climático",
"Una cuestión muy importante en los años de crecimiento económico, cuando la adopción de energías renovables fue un tema candente, el interés se redujo rápidamente cuando la crisis financiera golpeó a España, y no se ha recuperado desde entonces realmente.",
"Nos dimos cuenta de una caída aislada en el Congreso a finales de 2002, coincidiendo con el único momento en que el Medio Ambiente fue una de las preocupaciones de los ciudadanos. La razón fue el hundimiento del Prestige y el derrame de petróleo que contaminó la costa de Galicia."]},
		   "salud":{nombre:"Salud",name:"Health",description:["Algunas palabras clave principales son: Sanidad Pública, Sistema Sanitaria, Gasto farmacéutico",
"La salud es uno de los pocos temas, junto con Economía, para el que el Congreso y el CIS muestran tendencias similares. Intereses que rara vez supera el 10% en ambos casos. Mientras que las preocupaciones de la gente acerca de la salud no cambian mucho con el tiempo si lo hacen cuando hay reformas sanitarias o las elecciones son inminentes ,  es entonces cuando se habla del sistema de atención sanitaria por ambas partes. "]},
		   "servicios publicos e infraestructuras":{nombre:"Servicios públicos e infraestructuras",name:"Public Services",description:["Incluye Infraestructuras.  Algunas palabras clave principales:. AVE, Red Convencional, Fomento",
"Los retrasos en la construcción, el crecimiento y los costos inesperados, la elección de las líneas que se construyeron, y la infrautilización de algunas de ellas han hecho que el AVE un tema controvertido estos últimos 15 años. Por lo tanto, ha habido muchas preguntas al respecto en las sesiones de control del Congreso. El gasto público en algunas regiones también se ha convertido en un problema en los últimos años. ",
"Los españoles no califica a los Servicios Públicos o las Infraestructuras como cuestiones preocupantes, probablemente debido a que no son tan urgentes como los demás."]},
		   "social":{nombre:"Social",name:"Social",description:["Algunas palabras clave principales son: Igualdad, Servicios Sociales, Pobreza",
"Una categoría que incluye la igualdad social y los derechos de las mujeres no obtiene más de 2% del tiempo de nuestros políticos, mientras en las calles algunas personas se preocupan claramente acerca de estos temas. Tenemos que admitir que este fue uno de los gráficos que mas desconcertaron a la mayoría. ",
"Una posible razón de los bajos valores en el Congreso es que muchas de las palabras clave de la categoría social tienden a ser genéricas. Cuando se encuentra con otras palabras más específicas, los documentos que los contengan serían entonces asignados a otras categorías. Por lo tanto, sólo una pequeña parte de los documentos relacionados con la palabra clave 'social' se clasificaría como 'Social'. ",
"A modo de ejemplo, la creciente pobreza es un tema vagamente definido mientras que el desempleo y los desalojos, directamente relacionados con él, son más fáciles de etiquetar con palabras clave más específicas."]},
		   "terrorismo":{nombre:"Terrorismo", name:"Terrorism",description:["Algunas palabras clave principales son: ETA, País Vasco, Política Antiterrorista",
"Durante la década de la década de 1990  ETA perpetró numerosos atentados y asesinatos. Al entrar en la década de 2000 el terrorismo internacional fue también en aumento, por lo que continuó siendo un asunto muy serio para los españoles, como lo ilustran los datos del CIS. En fuerte contraste con esto, pocas preguntas sobre terrorismo se propusieron al gobierno en las sesiones de control. ",
"Creemos que la razón de ello puede ser bastante única en la política, todas las partes estaban de acuerdo con las medidas adoptadas por el gobierno. Por supuesto el terrorismo tuvo una alta presencia en la agenda de los políticos españoles, pero no había ninguna necesidad de discutir sobre ello. Durante la última década, la gente ha desviado su atención del terrorismo a otros asuntos, pero todavía se puede ver las consecuencias del bombardeo de Atocha, en marzo de 2004 y el bombardeo del aeropuerto de Barajas en diciembre de 2006 en los datos. ",
"Hoy en día, las personas no se preocupan ya no se preocupan por el terrorismo. A pesar de eso, el asunto tiene todavía  en el Congreso tanta importancia como la tuvo hace una década"]},
		   "vivienda":{nombre:"Vivienda",name:"Housing",description:["Algunas palabras clave: Vivienda Protegida, Protección Oficial, Suelo",
" Hasta mediados de la década pasada teníamos una economía fundada en el creciente precio de los inmuebles destinados a mucha gente que no era capaz de comprar una casa. Hasta 2004, la oposición de la izquierda, sobre todo el PSOE, solía discutir el tema con cierta regularidad . La política del partido gobernante de derechas, el PP, era visto como una de las principales razones por las que los bienes raíces estaba siendo fuertemente especulados. ",
"Después del cambio de gobierno en 2004, el PP no insistió en el tema a tratar. No obstante, los precios siguieron aumentar pese a los intentos del nuevo gobierno para frenarlos. Según el CIS, la gente sentía que la situación fue a peor hasta 2008. La crisis financiera mundial significó un repentino estallido de la burbuja inmobiliaria española: los precios cayeron y la vivienda se hizo poco a poco más asequible  y los políticos pasaron a los nuevos problemas de la crisis trajo "]}};

// Entre 01/09/2000 i 11/3/2015 hi han 5304 dies
var rangeDays = 5304;

// Chart dimensions.
var margin = {top: 19.5, right: 19.5, bottom: 19.5, left: 39.5},
    width = 960 - margin.right,
    height = 500 - margin.top - margin.bottom;

// Various scales. These domains make assumptions of data, naturally.
/*
var xScale = d3.scale.log().domain([300, 1e5]).range([0, width]),
    yScale = d3.scale.linear().domain([10, 85]).range([height, 0]),
    radiusScale = d3.scale.sqrt().domain([0, 5e8]).range([0, 40]),
    colorScale = d3.scale.category10();
*/
//
var xMin = -0.005, xMax = 0.5;
var yMin = -0.05, yMax = 0.5;
var rMin = 0, rMax = 1.0;
var xScale = d3.scale.sqrt().domain([xMin, xMax]).range([0, width]),
    yScale = d3.scale.linear().domain([yMin, yMax]).range([height, 0]),
    radiusScale = d3.scale.sqrt().domain([rMin, rMax]).range([0, 120]),
    colorScale = d3.scale.category20();

// The x & y axes.
/*
var xAxis = d3.svg.axis().orient("bottom").scale(xScale).ticks(12, d3.format(",d")),
    yAxis = d3.svg.axis().scale(yScale).orient("left");
*/
var xAxis = d3.svg.axis().ticks(10).tickFormat(d3.format("%")).orient("bottom").scale(xScale),
    yAxis = d3.svg.axis().ticks(10).tickFormat(d3.format("%")).orient("left").scale(yScale);

// Create the SVG container and set the origin.
var svg = d3.select("#chart").append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
  .append("g")
    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

// Add the x-axis.
svg.append("g")
    .attr("class", "x axis")
    .attr("transform", "translate(0," + height + ")")
    .call(xAxis);

// Add the y-axis.
svg.append("g")
    .attr("class", "y axis")
    .call(yAxis);

// Add an x-axis label.
svg.append("text")
    .attr("class", "x label")
    .attr("text-anchor", "end")
    .attr("x", width)
    .attr("y", height - 6)
    .text("CIS (" + (100.*xMin).toFixed(0) + "% - " + (100.*xMax).toFixed(0) + "%)");

// Add a y-axis label.
svg.append("text")
    .attr("class", "y label")
    .attr("text-anchor", "end")
    .attr("y", 6)
    .attr("dy", ".75em")
    .attr("transform", "rotate(-90)")
    .text("Congreso (" + (100.*yMin).toFixed(0) + "% - " + (100.*yMax).toFixed(0) + "%)");

// Add the year label; the value is set on transition.
var label = svg.append("text")
    .attr("class", "year label")
    .attr("text-anchor", "end")
    // .attr("y", height - 24)
	.attr("y", 48)
    .attr("x", width)
    .text("09/2000");
	
var line = d3.svg.line()
    .interpolate("basis")
    .x(function(d, i) { return d[0]; })
    .y(function(d, i) { return d[1]; });
	
var ptdata = {};

// Status flags
var first_execution = true;
var transition_running = false;

///////////////////////////////////////////////////////////////////////////////
// Initial configuration
var transition_length = 60 * 1000; // transition duration in milliseconds
var enable_overlay = true;
var show_topic_comments = true;
var initial_selection = ['all'];
///////////////////////////////////////////////////////////////////////////////
	
// Load the data.
function loadAndStart() {

  d3.json("common_nations_list_es.json", function(data) {

  // Add menu options
  if (first_execution) {
	if (initial_selection==null && initial_selection.length == 0) {
		for(var item in menu_topics) {
			var opt = document.createElement('option')
			opt.innerHTML = menu_topics[item];
			opt.value = item;
			if (item == 'all') {
				opt.selected = true;
			}
			topic_filter.appendChild(opt);
		}
	}
	else {
		for(var item in menu_topics) {
			var opt = document.createElement('option')
			opt.innerHTML = menu_topics[item];
			opt.value = item;
			if (initial_selection.indexOf(item) > -1) {
				opt.selected = true;
			}
			topic_filter.appendChild(opt);
		}
	}
  }
  /*
  else {
	// Remove topic_filter previous options
    for(var i=topic_filter.options.length-1;i>=0;i--)
	{
		topic_filter.remove(i);
	}
  
	for(var item in menu_topics) {
		var opt = document.createElement('option')
		opt.innerHTML = menu_topics[item];
		opt.value = item;
		topic_filter.appendChild(opt);	
	}
  }
  */
  first_execution = false;
  
  // Filter by menu options
  var options = topic_filter && topic_filter.options;
  var selected_filter = new Array();
  for (var i=0, iLen=options.length; i<iLen; i++) {
    if (options[i].selected) {
      selected_filter.push(options[i].value);
    }
  } 
  
  var all_selected = (selected_filter.indexOf('all') > -1);
  if (selected_filter.length==0) {
	all_selected = true;
  }
  var nations = new Array();
  for(i=0; i<data.length; i++) {
	if (all_selected || (selected_filter.indexOf(data[i].name) > -1) ) {
		nations.push(data[i]);
		ptdata[data[i].name] = new Array();
	}
  }
  
  // Add comments to selected topics
  if (show_topic_comments) {
	addComments(selected_filter);
  }
  
  // Add overlay help
  if (enable_overlay) {
	overlay_help.innerHTML = "Mover el ratón sobre el mes/año para ir hacia adelante y atrás en el tiempo."
  }

  formatDateToControl = d3.time.format("%m/%Y");

  // A bisector since many topic data is sparsely-defined.
  var bisect = d3.bisector(function(d) { return d[0]; });
  
  var elemEnter = svg.append("g")
      .attr("class", "dots")
    .selectAll(".dot")
      .data(interpolateData(0))
    .enter();

  // Add a path
  var path_dot = null;
  var trace_checkbox=document.getElementById('trace_checkbox'); 
  if (trace_checkbox.checked) {
	path_dot = elemEnter.append("path")
    .attr("class", function(d){return "line-"+d.name.replace(' ','-');})
	.attr("fill","none")
	.attr("stroke", function(d) { return colorScale(color(d)); })
	.attr("stroke-width", "3px")
	// .attr("stroke-dasharray", ("2,5"))
    .attr("d", line);
  }
	
  // Add a circle
  var dot = elemEnter.append("circle")
      .attr("class", "dot")
      .style("fill", function(d) { return colorScale(color(d)); })
      .call(position)
      .sort(order);
	  
  // Add a title.
  dot.append("title")
	  .attr("class", "dot_title")
	  .text(function(d) {var result = d.name;});
	  
  // Add a label to circle	
  var label_dot = elemEnter.append("text")
	.attr("class", "label_dot")
	.style("text-anchor", "middle")
	.call(label_position)
	.sort(order)
	.text(function(d){return d.name;});
	  
  // Add an overlay for the month/year label.
  var box = label.node().getBBox();
  
  var overlay = null;
  if (enable_overlay) {
    overlay = svg.append("rect")
        .attr("class", "overlay")
        .attr("x", box.x)
        .attr("y", box.y)
        .attr("width", box.width)
        .attr("height", box.height)
        .on("mouseover", enableInteraction);
  }
  
  // Start a transition that interpolates the data based on month/year.
  transition_running = true;
  svg.transition()
      .duration(transition_length)
      .ease("linear")
      .tween("year", tweenYear)
      .each("end", enableInteraction);

  // Positions the dots based on data.
  function position(dot) {
    dot .attr("cx", function(d) { return xScale(x(d)); })
        .attr("cy", function(d) { return yScale(y(d)); })
        .attr("r", function(d) { return radiusScale(radius(d)); });
	
	// Remove previous title
    dot.selectAll(".dot_title").remove();
	// Add a new title.
	dot.append("title")
	  .attr("class", "dot_title")
      .text(function(d) {  
		  var result = d.name + ":";
		  if (x(d) > 0) {
			  result += "\nCIS: (" + (100.*x(d)).toFixed(2) + "%)";
		  }
		  if (y(d) > 0) {
			  result += "\nCongreso: (" + (100.*y(d)).toFixed(2) + "%)";
		  }
		  result += "\nGlobal: (" + (100.*radius(d)).toFixed(2) + "%)";
		  return result;	  
	});
	
  }
  
  function path_position(path_dot, year_data) {
  
	for (i=0; i<year_data.length; i++) {
		var pt = new Array();
		pt.push(xScale(x(year_data[i])));
		pt.push(yScale(y(year_data[i])));		
		ptdata[year_data[i].name].push(pt);
		path_dot_name = d3.selectAll(".line-"+year_data[i].name.replace(' ','-'));
		path_dot_name.data([ptdata[year_data[i].name]]);
		// path_dot_name.attr("stroke-width", 2*radiusScale(radius(year_data[i])) + "px")
	}
	
	// Redraw the path_dot:
	path_dot.attr("d", function(d) { return line(d);})  
  }
  
  function label_position(label_dot) {
    label_dot	.attr("dx", function(d) { return xScale(x(d)); })
				.attr("dy", function(d) { return yScale(y(d)); })
				// .style("font-size", function(d) { return Math.round(radiusScale(radius(d))/3.)+"px"; });
				.style("font-size", function(d) { return (radiusScale(radius(d))/3.).toFixed(2)+"px"; });
  }

  // Defines a sort order so that the smallest dots are drawn on top.
  function order(a, b) {
    return radius(b) - radius(a);
  }
  
  // After the transition finishes, you can mouseover to change the year.
  function enableInteraction() {
    var yearScale = d3.scale.linear()
        .domain([0, rangeDays])
        .range([box.x + 10, box.x + box.width - 10])
        .clamp(true);

    // Cancel the current transition, if any.
    svg.transition().duration(0);
	transition_running = false;

	if (enable_overlay) {
		overlay
			.on("mouseover", mouseover)
			.on("mouseout", mouseout)
			.on("mousemove", mousemove)
			.on("touchmove", mousemove);
	}

    function mouseover() {
      label.classed("active", true);
    }

    function mouseout() {
      label.classed("active", false);
    }

    function mousemove() {
      displayYear(yearScale.invert(d3.mouse(this)[0]));
    }
  }

  // Tweens the entire chart by first tweening the year, and then the data.
  // For the interpolated data, the dots and label are redrawn.
  function tweenYear() {
    var year = d3.interpolateNumber(0, rangeDays);
    return function(t) { displayYear(year(t)); };
  }

  // Updates the display to show the specified year.
  function displayYear(year) {
  
	var year_data = interpolateData(year);
  
    dot.data(year_data, key).call(position).sort(order);
	label_dot.data(year_data, key).call(label_position).sort(order);
	
	if (path_dot!=null && transition_running) {
		path_position(path_dot,year_data);
	}
	
    // label.text(Math.round(year));
	var from = new Date('2000-09-01T00:00:00');
	var result = new Date(from);
    result.setDate(from.getDate() + year);
	label.text(formatDateToControl(result));
  }

  // Interpolates the dataset for the given (fractional) year.
  function interpolateData(year) {
    return nations.map(function(d) {
		return {
			name: d.name,
			region: d.region,
			income: interpolateValues(d.income, year),
			population: interpolateValues(d.population, year),
			lifeExpectancy: interpolateValues(d.lifeExpectancy, year)
		  };
    });
  }

  // Finds (and possibly interpolates) the value for the specified year.
  function interpolateValues(values, year) {
    var i = bisect.left(values, year, 0, values.length - 1),
        a = values[i];
    if (i > 0) {
      var b = values[i - 1],
          t = (year - a[0]) / (b[0] - a[0]);
	  var result = a[1] * (1 - t) + b[1] * t;
      return (result>0)?result:0.0;
    }
    return a[1];
  }
});
}

function addComments(selected_filter) {

	var div_topics_comments = d3.select("#topics_comments");
	div_topics_comments.selectAll("*").remove();
  
	for(var i=0; i<selected_filter.length; i++) {
		if (selected_filter[i]!="all" && par[selected_filter[i]]!=null) {
			div_topics_comments.append("hr");
			div_topics_comments.append("p").html("<b>" + par[selected_filter[i]].name + "</b>" + " (Tópico: \"" + par[selected_filter[i]].nombre + "\")");
			par[selected_filter[i]].description.forEach(function(d){
				return d3.select("#topics_comments").append("p").text(d);
			});
		}
	}
	div_topics_comments.append("hr");
}

function cleanAndStart() {
	// Clean
	svg.selectAll(".dots").remove();
	
	// Load and start
	loadAndStart();
}

loadAndStart();

</script>
