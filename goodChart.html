<!DOCTYPE html>
<meta charset="utf-8">

<style>

body {
  font: 16px sans-serif;
}

.axis path,
.axis line {
  fill: none;
  stroke: #000;
  shape-rendering: crispEdges;
}

.x.axis path {
  display: none;
}

.area.above {
  fill: #1f77b4;
}

.area.below {
  fill: #ff7f0e;
}

.line1 {
  fill: none;
  stroke: #000;
  stroke-width: 1.5px;
}

.line2 {
  fill: none;
  stroke: #000;
  stroke-width: 1.5px;
}

.year.label {
  font: 500 76px "Helvetica Neue";
  fill: #ddd;
}

</style>
<body>
<script src="http://d3js.org/d3.v3.js"></script>
<script>

var margin = {top: 20, right: 20, bottom: 30, left: 50},
	padWidth = 200,
    width = 960 - margin.left - margin.right + padWidth,
    height = 500 - margin.top - margin.bottom;

var tema = "corrupcion";
var parseDate = d3.time.format("%Y%m%d").parse;

var topics = ["Corruption","Economy","Education","Jobs","Ideology","Crime","Youth","Justice",
			  "Environment","Others","Health","Public Services","Social","Terrorism","Housing"];
			  
var par = {"Corruption":["Some top keywords: Agencia Tributaria, Fraude Fiscal, Amnistía Fiscal",
						 "A very important issue in Spain these days, we discovered that our politicians don't discuss corruption very often, at least in the control sessions. Despite the steep rise of the number of known cases these last years, early 2003 remains the stand-out period, when the Aznar government reduced taxes to tackle the problems of money laundering and tax evasion. Some parties harshly critizised the timing of the move, since the general election of 2004 was scheduled only a few months ahead.",
						 "The people, though, have reacted strongly to the multiple scandals since 2010. We could see a sharp increase from that year onwards, coincing with the end of the worst part of the financial crisis. 2013 saw a whole new wave of cases of illegal funding and tax evasion regarding the principal political parties. After that, corruption has become the second most important issue for the Spanish people (the first being Jobs).",
						 "However, the public outcry hasn't made any noticeable difference in the Congress. The last wave of scandals, involving almost every party in the country, have not led to increased appearance of the matter in the control sessions."],
		   "Economy":["Some top keywords: Empresas, Política Industrial, Economía Española",
					  "As expected, 2008 saw a notable rise in the interest of both politicians and people in Economy. The financial crisis hit Spain specially hard, and it triggered a property bubble whose effects last until today (more on that in Housing and Jobs).",
					  "Before that, we could observe that the introduction of the Euro in 2002 did bother the politicians, while there hardly seems to be any interest from the Spanish people. After 2012 there is a marked decline in interest from both groups. A possible reason could be that the focus of the crisis no longer is on the banks or financial institutions, but on people's problems like unemployment.",
					  "Economy is actually the topic on which the interest of the politicians better reflects the interest in the subject of the people they represent."],
		   "Education":["Some top words: Sistema Educativo, Formación Profesional, Fracaso Escolar",
						"Despite occasional surges of activity in the Congress, Education has remained a quiet issue for the last 15 years. On one hand, large portions of the population have no natural interest in education, having already finished theirs. Therefore, despite occasional highly visible demonstrations, the CIS gives Education a relative small importance.",
						"On the other hand, some situations involving politics did became highly politicised in recent years, explaining the brief surges in interest by the Congress. The introduction of the Bolonia Plan in 2008 was met by strong opposition from many parties, who argued that it was the first step towards the privatization of universities. The resistance of the Catalan government to the so called 'Ley Wert', which intended to reduce the number of lective hours in Catalan, led to some heated exchanges in 2014, as it was seen as a form of repression against Catalunya. Despite all this, Education never surpasses a 4% on the CIS barometer."],
		   "Jobs":["Some top keywords: Reforma Laboral, Negociación Colectiva, Paro",
				   "Unemployment has been an issue in Spain for many years. In the last 15 years, the CIS value for Jobs has never failed to reach 20%.",
				   "Despite being one of the most pressing problems in Spain, the importance of Employment has been at most moderate in the control sessions of the Congress. Isolated high points in 2008 and 2012 could indicate that Employment remains a hot topic before general elections, but even in those occasions the gap remains markedly wide."],
		   "Ideology":["Some top keywords: Guerra Civil, Memoria Histórica, Vasco",
					   "Ideology belongs to a group of issues that, although they appear in the Congress every now and then, are of very little importance to people according to the CIS. But in the middle of a financial crisis, with people losing jobs and homes, it shouldn't surprise anyone that Spaniards don't worry about historic memory or the victims of the Civil War. In spite of that, there are still periods where this matters keep our representatives busy. We noticed that the last mentioned issue, the victims of the Civil War, was often brought up in the sessions of control in late 2003."],
		   "Crime":["Some top keywords: Seguridad Ciudadana, Policía, Guardia Civil",
					"Almost always under 10% of interest, Crime has seen two opposite trends in recent years. On one hand, there is an increased presence of the subject in the Congress' discussions. On the other hand, Spanish people don't list Crime so often as one of their main worries since 2007. The crisis and the more urgent problems it brought could be an explanation for the latter trend.",
					"The explanation behind the first trend is quite different from what one may expect. Starting 2010, austerity politics resulted in considerably reduced spending in some areas, one of them the police force (Guardia Civil). Very often, parties against spending cuts would use this to question the ruling party. Thus, the 'Guardia Civil' became a matter of discussion in the Congress."],
		   "Youth":["Some top keywords: Jóvenes, Paro Juvenil, Garantía Juvenil",
					"An irregular but ever-present matter in the Congress, Youth covers related issues such as lack of opportunities for and massive emigration of highly qualified young people. After some years of reduced attention, the surge of new political parties since 2012 has led to an increase in Youth issues. Young people are considered to be the key in the upcoming general election.",
					"Youth is rated as a very peripheric problem by Spaniards, undoubtedly because of the general situation of the country."],
		   "Justice":["Some top keywords: Fiscal General, Estatuto Orgànico, Tribunal Supremo",
					  "The slow judiciary system has long been a recurrent thema in Spain. The start of the crisis in 2008 shifted the attention towards other issues, until the cases of corruption brought it back on the matter. We decided to treat Corruption and Justice separately, since we could identify both clusters pretty well. Contrary to Corruption, Justice does appear more often in the Congress since 2012. It seems politicians prefer to talk about the judges than about the judged ones...",
					  "Anyway, Spanish people seem to be able to identify one of them as the real problem, and it is Corruption, not Justice."],
		   "Environment":["Some top keywords: Energías Renovables, Seguridad Nuclear, Cambio Climático",
						  "A pretty important matter in the years of economic growth, when the adoption of renewable energies was a hot issue, interest fell quickly when the financial crisis hit Spain, and has not truly recovered since.",
						  "We noticed an isolated fall in Congress in late 2002, coinciding with the only time people gave Environment as one of their worries. The reason people did so is the sinking of the Prestige and the oil spill that polluted the coastline of Galicia."],
		   "Others":["Includes Culture, Defense, Internacional. Some top keywords: Investigación, Cultura, Deporte"],
		   "Health":["Some top keywords: Sanidad Pública, Sistema Sanitaria, Gasto Farmacéutico",
					 "Health is one of the few issues, together with Economy, for which Congress and CIS show similar trends. Interest rarely surpasses 10% in both cases. While people's worries about health don't change much over time, health care reforms or impending elections, when health care system is discussed by all parties, make sure Health gets a little more attention in the Congress every now and then."],
		   "Public Services":["Includes Infrastructures. Some top keywords: AVE, Red Convencional, Fomento",
							  "Delays in construction, growing and unexpected costs, the choice of the lines to be built, and the underuse of some of them have made the AVE a controversioal issue these last 15 years. As such, there have been many questions about it in the sessions of control of the Congress. Public spending in some regions has also become an issue in recent years.",
							  "Spanish people don't rate Public Services or Infrastructures as worrying issues, probably because they aren't as pressing as others."],
		   "Social":["Some top keywords: Igualdad, Servicios Sociales, Pobreza",
					 "A category which includes social equality and women's rights doesn't get more than 2% of the time of our politicians, while on the streets some people clearly care about these themes. We have to admit that this was one of the graphics that puzzled us the most.",
					 "One possible reason for the low values in Congress is that many of the keywords of the category Social tend to be generic. When found with other more specific keywords, the documents containing them would then be assigned to other categories. Therefore, only a small portion of the documents involving 'Social' keywords would be classified as 'Social'.",
					 "As an example, growing poverty is a vaguely defined issue while unemployment and evictions, directly related to it, are easier to label with keywords that are specific to them."],
		   "Terrorism":["Some top keywords: ETA, País Vasco, Política Antiterrorista",
						"The decade of the 1990s saw ETA perpetrate numerous murders and bombings. Going into the 2000s international terrorism was on the rise too, and so terrorism was a very serious matter for the Spanish people, as illustrated by the CIS data. In strong contrast to this, few questions about terrorism were put to the government in the sessions of control.",
						"We believe the reason of it may be quite unique in politics, in that all parties agreed on the measures taken by the government. Of course terrorism was high in the agenda of Spanish politicians, there was just no need to discuss about it. During the last decade, people have shifted their attention from terrorism to other matters, but the consequences of the Atocha Bombing in March 2004 and the Barajas Airport Bombing in December 2006 still can be seen in the data.",
						"Nowadays, people don't worry about terrorism any more. In spite of that, the matter still comes up in the Congress as much as it did a decade ago."],
		   "Housing":["Some top keywords: Vivienda Protegida, Protección Oficial, Suelo",
					  "An economy founded on ever-growing real estate prices meant a lot of people weren't able to afford a home by the mid 2000s. Until 2004, the opposition from the left, mainly the PSOE, seeked to discuss the issue with certain regularity. The politics of the ruling rigth party, the PP, were seen as one of the main reasons real estate was being heavily speculated with.",
					  "After the change in the government in 2004, the PP didn't press for the issue to be discussed. Nevertheless, the prices continued to raise despite the new government's attempts to curb them. According to the CIS, people felt the situation actually got worse until 2008. The global financial crisis meant a sudden burst of the Spanish property bubble. Prices fell, and as housing slowly became more affordable the interest of people and politicians turned to the new problems the crisis brought."]}
var x = d3.time.scale()
    .range([0, width - padWidth]);

var y = d3.scale.linear()
    .range([height, 0]);

var xAxis = d3.svg.axis()
    .scale(x)
    .orient("bottom");

var yAxis = d3.svg.axis()
    .scale(y)
    .orient("left");

var line1 = d3.svg.area()
    .interpolate("basis")
    .x(function(d) { return x(d.date); })
    .y(function(d) { return y(d["Congreso"]); });
	
var line2 = d3.svg.area()
    .interpolate("basis")
    .x(function(d) { return x(d.date); })
    .y(function(d) { return y(d["Cis"]); });

var area = d3.svg.area()
    .interpolate("basis")
    .x(function(d) { return x(d.date); })
    .y1(function(d) { return y(d["Congreso"]); });

var svg = d3.select("body").append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
	.append("g")
    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
	
var titPos = {"Corruption":250,
			  "Economy":320,
			  "Education":250,
			  "Jobs":450,
			  "Ideology":50,
			  "Crime":80,
			  "Youth":250,
			  "Justice":200,
			  "Environment":0,
			  "Others":80,
			  "Health":250,
			  "Public Services":50,
			  "Social":120,
			  "Terrorism":50,
			  "Housing":50}
			  
var legPos = {"Corruption":40,
			  "Economy":40,
			  "Education":40,
			  "Jobs":40,
			  "Ideology":300,
			  "Crime":300,
			  "Youth":40,
			  "Justice":40,
			  "Environment":250,
			  "Others":40,
			  "Health":100,
			  "Public Services":40,
			  "Social":40,
			  "Terrorism":200,
			  "Housing":40}
			  
par["Corruption"].forEach(function(d){
	return d3.select("body").append("p").text(d)
	});
	

d3.csv("dataForBiArea4.csv", function(error, data) {
	data.forEach(function(d) {
		d.date = parseDate(d.date);
		d["Congreso"]= +d[tema.concat("Congreso")];
		d["Cis"] = +d[tema.concat("Cis")];
	});
	
	
	
	var legend = ["More important to CIS","More important to Congress"];
	var title = ["Corruption"];
	
	svg.selectAll("rectLeg")
		.data(legend)
		.enter()
		.append("rect")
		.attr("y",function(d, i){
			return i*20;
		})
		.attr("class", "leg1")
		.attr("x", legPos[title[0]])
		.attr("height", 15)
		.attr("width", 15)
		.attr("fill", function(d, i){
			return d3.scale.category10().domain([0,1])(i);
		});
		
	svg.selectAll("textLeg")
		.data(legend)
		.enter()
		.append("text")
		.attr("y",function(d, i){
			return i*20 + 12;
		})
		.text(function(d){
					return d;
				})
		.attr("class", "leg2")
		.attr("x", legPos[title[0]] + 20)
		.attr("font-size", 14)
		.attr("text-anchor", "left");
	
	myTitle = svg.selectAll("Title").data(title)
		.enter()
		.append("text")
		.attr("class", "year label")
		.attr("text-anchor", "end")
		.text(function(d){
			return d;
		})
		.attr("x", width - padWidth - titPos[title[0]])
		.attr("y", 50);
	
	var padText = svg.selectAll("padText")
		.data(topics)
		.enter()
		.append('text')
		.attr("x", width + margin.right - padWidth / 2)
		.attr("y", function(d,i){
			return -margin.top + 3 + 20 + i * (height + margin.top + margin.bottom)/15;
		})
		.text(function(d){
			return d;
		})
		.attr("text-anchor", "middle")
		.attr("font-size", 18);
		
	var pad = svg.selectAll("pad")
		.data(topics)
		.enter()
		.append('rect')
		.attr("width", padWidth)
		.attr("height", (height + margin.top + margin.bottom)/15 - 6)
		.attr("x", width + margin.right - padWidth)
		.attr("y", function(d,i){
			return -margin.top + 3 + i * (height + margin.top + margin.bottom)/15;
		})
		.attr("fill","#ddd")
		.attr("opacity",0.4)
		.on("click",function(d){
					return change(d);
				});


	x.domain(d3.extent(data, function(d) { return d.date; }));

	y.domain([
		d3.min(data, function(d) { return Math.min(d["Congreso"], d["Cis"]); }),
		d3.max(data, function(d) { return Math.max(d["Congreso"], d["Cis"]); })
	]);

	svg.datum(data);

	clipPath1 = svg.append("clipPath")
		.attr("class", "clip")
		.attr("id", "clip-below")
		.append("path")
		.attr("d", area.y0(height));

	clipPath2 = svg.append("clipPath")
		.attr("class", "clip")
		.attr("id", "clip-above")
		.append("path")
		.attr("d", area.y0(0));

	path1 = svg.append("path")
		.attr("class", "area above")
		.attr("clip-path", "url(#clip-above)")
		.attr("d", area.y0(function(d) { return y(d["Cis"]); }));

	path2 = svg.append("path")
		.attr("class", "area below")
		.attr("clip-path", "url(#clip-below)")
		.attr("d", area);

	l1 = svg.append("path")
		.attr("class", "line1")
		.attr("d", line1);
	  
	l2 = svg.append("path")
		.attr("class", "line2")
		.attr("d", line2);

	svg.append("g")
		.attr("class", "x axis")
		.attr("transform", "translate(0," + height + ")")
		.call(xAxis);

	svg.append("g")
		.attr("class", "y axis")
		.call(yAxis)
		.append("text")
		.attr("transform", "rotate(-90)")
		.attr("y", 6)
		.attr("dy", ".71em")
		.style("text-anchor", "end")
		.text("% of importance");  
	

	function change(Tema){
		
		var tema = "";
		if (Tema == "Corruption"){
			tema = "corrupcion";
		} else if (Tema == "Economy"){
			tema = "economia";
		} else if (Tema == "Others"){
			tema = "otros";
		} else if (Tema == "Justice"){
			tema = "justicia";
		} else if (Tema == "Social"){
			tema = "social";
		} else if (Tema == "Health"){
			tema = "salud";
		} else if (Tema == "Environment"){
			tema = "ma";
		} else if (Tema == "Public Services"){
			tema = "spei";
		} else if (Tema == "Housing"){
			tema = "vivienda";
		} else if (Tema == "Terrorism"){
			tema = "terrorismo";
		} else if (Tema == "Jobs"){
			tema = "empleo";
		} else if (Tema == "Ideology"){
			tema = "ideologia";
		} else if (Tema == "Education"){
			tema = "educacion";
		} else if (Tema == "Youth"){
			tema = "jovenes";
		} else if (Tema == "Crime"){
			tema = "ic";
		}
		
		var title = [Tema];
    
		data.forEach(function(d) {
			d["Congreso"]= +d[tema.concat("Congreso")];
			d["Cis"] = +d[tema.concat("Cis")];
		});
	
		y.domain([
			d3.min(data, function(d) { return Math.min(d["Congreso"], d["Cis"]); }),
			d3.max(data, function(d) { return Math.max(d["Congreso"], d["Cis"]); })
		]);

		path1.transition().duration(750).style("opacity",0);
		path2.transition().duration(750).style("opacity",0);
		clipPath1.transition().duration(750).style("opacity",0);
		clipPath2.transition().duration(750).style("opacity",0);
		
		svg.selectAll(".year.label").transition().duration(375).style("opacity",0).remove();
		
		myTitle = svg.selectAll("Title").data(title)
			.enter()
			.append("text")
			.attr("class", "year label")
			.attr("text-anchor", "end")
			.text(function(d){
				return d;
			})
			.attr("x", width - padWidth - titPos[title[0]])
			.attr("y", 50)
			.attr("opacity",0)
			.transition().duration(375).delay(375)
			.attr("opacity",1);

	
		var t1 = svg.transition().duration(750).delay(750);
		t1.selectAll(".line1").attr("d", line1);
		t1.selectAll(".line2").attr("d", line2);
		t1.selectAll(".y.axis").call(yAxis);
		t1.selectAll(".leg1").attr("x", legPos[Tema]);
		t1.selectAll(".leg2").attr("x", legPos[Tema] + 20);
	
		function pintaAgain(){
	
			area = d3.svg.area()
				.interpolate("basis")
				.x(function(d) { return x(d.date); })
				.y1(function(d) { return y(d["Congreso"]); });
							
			clipPath1.attr("d", area.y0(height))
				.style("opacity",1);

			clipPath2.attr("d", area.y0(0))
				.style("opacity",1);

			path1.attr("d", area.y0(function(d) { return y(d["Cis"]); }))
				.style("opacity",1);

			path2.attr("d", area)
				.style("opacity",1);
		}
	
		setTimeout(pintaAgain, 1500);
		
		d3.selectAll("p").remove()
		par[Tema].forEach(function(d){
			return d3.select("body").append("p").text(d)
		});
	}

});

</script>
